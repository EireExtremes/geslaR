<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Fernando Mayer, Niamh Cahill" />


<title>Dealing with the GESLA dataset in R</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Dealing with the GESLA dataset in R</h1>
<h4 class="author">Fernando Mayer, Niamh Cahill</h4>



<p>The <strong>geslaR</strong> package was designed to fetch the <a href="https://gesla787883612.wordpress.com">GESLA</a> dataset into R, in
full or subsets of it. There a few ways that this can be achieved:</p>
<ul>
<li>Downloading the entire dataset locally, then load it into R and work
from there using the <a href="https://arrow.apache.org">Apache Arrow</a>
framework (<code>download_gesla()</code>)</li>
<li>Querying the hosted dataset directly from R, specifying the desired
subset (<code>query_gesla()</code>)</li>
<li>Using the GESLA Shiny app (thereafter called only geslaR-app), to
filter, visualise and possibly download subsets of the dataset
(<code>run_gesla_app()</code>)</li>
</ul>
<p>In the sections below, we will discuss each of these
possibilities.</p>
<div id="loading-the-package" class="section level2">
<h2>Loading the package</h2>
<p>When you first load the <strong>geslaR</strong> package into an R
session, two more packages will automatically be loaded:
<strong>arrow</strong> and <strong>dplyr</strong>.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">library</span>(geslaR)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="co">#&gt; Loading required package: arrow</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="co">#&gt; Attaching package: &#39;arrow&#39;</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="co">#&gt; The following object is masked from &#39;package:utils&#39;:</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a><span class="co">#&gt;     timestamp</span></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a><span class="co">#&gt; Loading required package: dplyr</span></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a><span class="co">#&gt; Attaching package: &#39;dplyr&#39;</span></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a><span class="co">#&gt; The following objects are masked from &#39;package:stats&#39;:</span></span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a><span class="co">#&gt;     filter, lag</span></span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a><span class="co">#&gt; The following objects are masked from &#39;package:base&#39;:</span></span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span></code></pre></div>
<p>These two packages are strictly necessary, as it is the way to deal
with a huge dataset, like GESLA, without actually loading it in memory
at once. The full GESLA dataset have more than 1.7 billion lines, and is
nearly impossible to load it in R (or any other RAM memory language,
like e.g. Python) all at once. To avoid this problem, there are two
possibilities:</p>
<ol style="list-style-type: decimal">
<li>Load (smaller) subsets of the full dataset</li>
<li>Use an “in-memory” analytics framework</li>
</ol>
<p>In the best case scenario, these two approaches can be used together
for maximum efficiency, and the <strong>geslaR</strong> package was
designed for this achievement.</p>
<p>Regardless the way GESLA data is loaded into R, the best way to deal
with it is using the <a href="https://arrow.apache.org">Apache Arrow</a>
framework. For a more detailed explanation and examples, please see the
<code>vignette(&quot;intro-to-arrow&quot;)</code>.</p>
</div>
<div id="downloading-the-full-gesla-dataset" class="section level2">
<h2>Downloading the full GESLA dataset</h2>
<p>If you want to explore the full GESLA dataset, you can download it
with the <code>download_gesla()</code> function. The simplest way to use
this function is to call it like</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="fu">download_gesla</span>()</span></code></pre></div>
<p>This will create a directory called <code>gesla_dataset</code> in the
current working directory (as defined by <code>getwd()</code>) and
download the full dataset locally. This downlopad may take some time, as
it depends on internet connection, but it’s necessary only once. Note
that this full dataset will need at least 7GB of (hard drive) storage,
so make sure this is feasible. However, once downloaded, you will have
access to the full dataset, and you will only need to do this once.</p>
<p>You will notice that the full dataset is composed by 5119 [Apache
Parquet][] files, ending in <code>.parquet</code></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="do">## Number of downloaded files</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="fu">length</span>(<span class="fu">list.files</span>(<span class="st">&quot;gesla_dataset&quot;</span>))</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="co">#&gt; [1] 61</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="do">## Check the first files</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">list.files</span>(<span class="st">&quot;gesla_dataset&quot;</span>))</span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a><span class="co">#&gt; [1] &quot;aranmore_island_leabgarrow-ara-irl-mi_c.parquet&quot;</span></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a><span class="co">#&gt; [2] &quot;aranmore-ara-irl-cmems.parquet&quot;                 </span></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a><span class="co">#&gt; [3] &quot;arklow_harbour_opw_station-ark-irl-mi_c.parquet&quot;</span></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a><span class="co">#&gt; [4] &quot;arklowharbour-ark-irl-cmems.parquet&quot;            </span></span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a><span class="co">#&gt; [5] &quot;ballycotton_harbour-bal-irl-mi_c.parquet&quot;       </span></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a><span class="co">#&gt; [6] &quot;ballycotton-bal-irl-cmems.parquet&quot;</span></span></code></pre></div>
<p>These files are the same originally distributed in the GESLA dataset,
so that each one refers to a site from where the data comes from. To
load this full dataset in R, use the <code>arrow::open_dataset()</code>
function, specifying the location of the <code>.parquet</code> files.
Altough there are many files, this function recognizes them as a single
dataset, because they all have the same structure (or “Schema”).</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="do">## Open dataset</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>da <span class="ot">&lt;-</span> <span class="fu">open_dataset</span>(<span class="st">&quot;gesla_dataset&quot;</span>)</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="do">## Check the object</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>da</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a><span class="co">#&gt; FileSystemDataset with 61 Parquet files</span></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a><span class="co">#&gt; date_time: timestamp[us]</span></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a><span class="co">#&gt; year: int64</span></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a><span class="co">#&gt; month: int64</span></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a><span class="co">#&gt; day: int64</span></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a><span class="co">#&gt; hour: int64</span></span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a><span class="co">#&gt; country: string</span></span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a><span class="co">#&gt; site_name: string</span></span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a><span class="co">#&gt; lat: double</span></span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a><span class="co">#&gt; lon: double</span></span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a><span class="co">#&gt; sea_level: double</span></span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a><span class="co">#&gt; qc_flag: int64</span></span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a><span class="co">#&gt; use_flag: int64</span></span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a><span class="co">#&gt; file_name: string</span></span>
<span id="cb4-19"><a href="#cb4-19" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb4-20"><a href="#cb4-20" tabindex="-1"></a><span class="co">#&gt; See $metadata for additional Schema metadata</span></span>
<span id="cb4-21"><a href="#cb4-21" tabindex="-1"></a><span class="do">## Verify class</span></span>
<span id="cb4-22"><a href="#cb4-22" tabindex="-1"></a><span class="fu">class</span>(da)</span>
<span id="cb4-23"><a href="#cb4-23" tabindex="-1"></a><span class="co">#&gt; [1] &quot;FileSystemDataset&quot; &quot;Dataset&quot;           &quot;ArrowObject&quot;      </span></span>
<span id="cb4-24"><a href="#cb4-24" tabindex="-1"></a><span class="co">#&gt; [4] &quot;R6&quot;</span></span></code></pre></div>
<p>Since this is an <code>ArrowObject</code> object, it will actually
not load the full dataset in memory (as it would if it was a standard R
object, such as a <code>tibble</code> or <code>data.frame</code>). Note
that some basic informations, such as <code>dim()</code> and
<code>names()</code> can be retrieved simply with</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="fu">dim</span>(da)</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="co">#&gt; [1] 18189361       13</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="fu">names</span>(da)</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a><span class="co">#&gt;  [1] &quot;date_time&quot; &quot;year&quot;      &quot;month&quot;     &quot;day&quot;       &quot;hour&quot;      &quot;country&quot;  </span></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a><span class="co">#&gt;  [7] &quot;site_name&quot; &quot;lat&quot;       &quot;lon&quot;       &quot;sea_level&quot; &quot;qc_flag&quot;   &quot;use_flag&quot; </span></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a><span class="co">#&gt; [13] &quot;file_name&quot;</span></span></code></pre></div>
<p>However, any other manipulation of the dataset must be made using
<strong>dplyr</strong> verbs. For example, to count the number of
observations by country, one could use</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>da <span class="sc">|&gt;</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>    <span class="fu">count</span>(country) <span class="sc">|&gt;</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>    <span class="fu">collect</span>()</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a><span class="co">#&gt; # A tibble: 3 × 2</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="co">#&gt;   country        n</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt;      &lt;int&gt;</span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a><span class="co">#&gt; 1 IRL     16975901</span></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a><span class="co">#&gt; 2 ATA      1084526</span></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a><span class="co">#&gt; 3 FRA       128934</span></span></code></pre></div>
</div>
<div id="querying-subsets-directly-into-r" class="section level2">
<h2>Querying subsets directly into R</h2>
<p>The <code>query_gesla()</code> function can be used to load subsets
of the full GESLA dataset into R. This function will connect to the
GESLA dataset hosted on an Amazon AWS S3 bucket, and will automatically
filter the required piece of data. Note that the query may take some
time, as it will depend on the size of the required subset and on
internet connection speed.</p>
<p>The selection is made by specifying one or more countries, years and
site names. The only mandatory argument is <code>country</code>, where
it should be a character vector of three-letter <a href="https://en.wikipedia.org/wiki/ISO_3166-1_alpha-3">ISO 3166-1
alpha-3</a> code. If the argument <code>year</code> is empty, then all
available years for those countries will be selected. The same accurs
for the <code>site_name</code> argument.</p>
<p>For example, to select all the available data for Ireland (IRL),
simply use</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>da <span class="ot">&lt;-</span> <span class="fu">query_gesla</span>(<span class="at">country =</span> <span class="st">&quot;IRL&quot;</span>)</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="co">#&gt; ℹ This process can take some time, as it depends on the size of the final dataset, and on</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="co">#&gt; internet connection.</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>ℹ Connecting to the data server...[K</span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>✔ Connecting to the data server... [<span class="fl">4.6</span>s][K</span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a>ℹ Filtering data. This can take some time...[K</span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a>✔ Filtering data. This can take some time... [6m <span class="fl">21.8</span>s][K</span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a>ℹ Query finished.[K</span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a>✔ Query finished. [13ms][K</span>
<span id="cb7-16"><a href="#cb7-16" tabindex="-1"></a>da</span>
<span id="cb7-17"><a href="#cb7-17" tabindex="-1"></a><span class="co">#&gt; Table</span></span>
<span id="cb7-18"><a href="#cb7-18" tabindex="-1"></a><span class="co">#&gt; 16321218 rows x 13 columns</span></span>
<span id="cb7-19"><a href="#cb7-19" tabindex="-1"></a><span class="co">#&gt; $date_time &lt;timestamp[us]&gt;</span></span>
<span id="cb7-20"><a href="#cb7-20" tabindex="-1"></a><span class="co">#&gt; $year &lt;int64&gt;</span></span>
<span id="cb7-21"><a href="#cb7-21" tabindex="-1"></a><span class="co">#&gt; $month &lt;int64&gt;</span></span>
<span id="cb7-22"><a href="#cb7-22" tabindex="-1"></a><span class="co">#&gt; $day &lt;int64&gt;</span></span>
<span id="cb7-23"><a href="#cb7-23" tabindex="-1"></a><span class="co">#&gt; $hour &lt;int64&gt;</span></span>
<span id="cb7-24"><a href="#cb7-24" tabindex="-1"></a><span class="co">#&gt; $country &lt;string&gt;</span></span>
<span id="cb7-25"><a href="#cb7-25" tabindex="-1"></a><span class="co">#&gt; $site_name &lt;string&gt;</span></span>
<span id="cb7-26"><a href="#cb7-26" tabindex="-1"></a><span class="co">#&gt; $lat &lt;double&gt;</span></span>
<span id="cb7-27"><a href="#cb7-27" tabindex="-1"></a><span class="co">#&gt; $lon &lt;double&gt;</span></span>
<span id="cb7-28"><a href="#cb7-28" tabindex="-1"></a><span class="co">#&gt; $sea_level &lt;double&gt;</span></span>
<span id="cb7-29"><a href="#cb7-29" tabindex="-1"></a><span class="co">#&gt; $qc_flag &lt;int64&gt;</span></span>
<span id="cb7-30"><a href="#cb7-30" tabindex="-1"></a><span class="co">#&gt; $use_flag &lt;int64&gt;</span></span>
<span id="cb7-31"><a href="#cb7-31" tabindex="-1"></a><span class="co">#&gt; $file_name &lt;string&gt;</span></span>
<span id="cb7-32"><a href="#cb7-32" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb7-33"><a href="#cb7-33" tabindex="-1"></a><span class="co">#&gt; See $metadata for additional Schema metadata</span></span>
<span id="cb7-34"><a href="#cb7-34" tabindex="-1"></a><span class="fu">dim</span>(da)</span>
<span id="cb7-35"><a href="#cb7-35" tabindex="-1"></a><span class="co">#&gt; [1] 16321218       13</span></span>
<span id="cb7-36"><a href="#cb7-36" tabindex="-1"></a><span class="fu">names</span>(da)</span>
<span id="cb7-37"><a href="#cb7-37" tabindex="-1"></a><span class="co">#&gt;  [1] &quot;date_time&quot; &quot;year&quot;      &quot;month&quot;     &quot;day&quot;       &quot;hour&quot;      &quot;country&quot;  </span></span>
<span id="cb7-38"><a href="#cb7-38" tabindex="-1"></a><span class="co">#&gt;  [7] &quot;site_name&quot; &quot;lat&quot;       &quot;lon&quot;       &quot;sea_level&quot; &quot;qc_flag&quot;   &quot;use_flag&quot; </span></span>
<span id="cb7-39"><a href="#cb7-39" tabindex="-1"></a><span class="co">#&gt; [13] &quot;file_name&quot;</span></span>
<span id="cb7-40"><a href="#cb7-40" tabindex="-1"></a><span class="fu">class</span>(da)</span>
<span id="cb7-41"><a href="#cb7-41" tabindex="-1"></a><span class="co">#&gt; [1] &quot;Table&quot;        &quot;ArrowTabular&quot; &quot;ArrowObject&quot;  &quot;R6&quot;</span></span></code></pre></div>
<p>This is also an <code>ArrowObject</code> object, and works the same
way as any other Arrow object type, i.e., it can be manipulated with
<strong>dplyr</strong> verbs. By the end of this section we will show
some examples.</p>
<p>Many other queries can be made, for example,</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="do">## Select one specific year</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>da <span class="ot">&lt;-</span> <span class="fu">query_gesla</span>(<span class="at">country =</span> <span class="st">&quot;IRL&quot;</span>, <span class="at">year =</span> <span class="dv">2015</span>)</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a><span class="do">## Multiple years</span></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>da <span class="ot">&lt;-</span> <span class="fu">query_gesla</span>(<span class="at">country =</span> <span class="st">&quot;IRL&quot;</span>, <span class="at">year =</span> <span class="fu">c</span>(<span class="dv">2015</span>, <span class="dv">2017</span>))</span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>da <span class="ot">&lt;-</span> <span class="fu">query_gesla</span>(<span class="at">country =</span> <span class="st">&quot;IRL&quot;</span>, <span class="at">year =</span> <span class="dv">2010</span><span class="sc">:</span><span class="dv">2017</span>)</span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>da <span class="ot">&lt;-</span> <span class="fu">query_gesla</span>(<span class="at">country =</span> <span class="st">&quot;IRL&quot;</span>, <span class="at">year =</span> <span class="fu">c</span>(<span class="dv">2010</span>, <span class="dv">2012</span>, <span class="dv">2015</span>))</span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a><span class="do">## Multiple countries</span></span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a>da <span class="ot">&lt;-</span> <span class="fu">query_gesla</span>(<span class="at">country =</span> <span class="fu">c</span>(<span class="st">&quot;IRL&quot;</span>, <span class="st">&quot;ATA&quot;</span>), <span class="at">year =</span> <span class="dv">2015</span>)</span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a>da <span class="ot">&lt;-</span> <span class="fu">query_gesla</span>(<span class="at">country =</span> <span class="fu">c</span>(<span class="st">&quot;IRL&quot;</span>, <span class="st">&quot;ATA&quot;</span>), <span class="at">year =</span> <span class="dv">2010</span><span class="sc">:</span><span class="dv">2017</span>)</span></code></pre></div>
<p>As one last example, we may be interested in data only for the site
<code>Dublin_Port</code> in Ireland, and for the years 2015 and 2017.
This query would be done as follows</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>da <span class="ot">&lt;-</span> <span class="fu">query_gesla</span>(<span class="at">country =</span> <span class="st">&quot;IRL&quot;</span>, <span class="at">year =</span> <span class="fu">c</span>(<span class="dv">2015</span>, <span class="dv">2017</span>),</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>    <span class="at">site_name =</span> <span class="st">&quot;Dublin_Port&quot;</span>)</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="co">#&gt; ℹ This process can take some time, as it depends on the size of the final dataset, and on</span></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a><span class="co">#&gt; internet connection.</span></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>ℹ Connecting to the data server...[K</span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a>✔ Connecting to the data server... [<span class="fl">4.4</span>s][K</span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a>ℹ Filtering data. This can take some time...[K</span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a>✔ Filtering data. This can take some time... [4m <span class="fl">21.5</span>s][K</span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a>ℹ Query finished.[K</span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a></span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a>✔ Query finished. [18ms][K</span></code></pre></div>
<p>Now we could explore this subset using <strong>dplyr</strong> verbs
as usual</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="do">## Verifying number of observations per year</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>da <span class="sc">|&gt;</span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>    <span class="fu">count</span>(year) <span class="sc">|&gt;</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>    <span class="fu">collect</span>()</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a><span class="co">#&gt; # A tibble: 2 × 2</span></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a><span class="co">#&gt;    year      n</span></span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a><span class="co">#&gt;   &lt;int&gt;  &lt;int&gt;</span></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a><span class="co">#&gt; 1  2015  93790</span></span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a><span class="co">#&gt; 2  2017 104835</span></span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a><span class="do">## Calculating summary statistics per year</span></span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a>da <span class="sc">|&gt;</span></span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a>    <span class="fu">group_by</span>(year) <span class="sc">|&gt;</span></span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a>        <span class="at">min =</span> <span class="fu">min</span>(sea_level),</span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a>        <span class="at">mean =</span> <span class="fu">mean</span>(sea_level),</span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a>        <span class="at">max =</span> <span class="fu">max</span>(sea_level)) <span class="sc">|&gt;</span></span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a>    <span class="fu">collect</span>()</span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a><span class="co">#&gt; # A tibble: 2 × 4</span></span>
<span id="cb10-20"><a href="#cb10-20" tabindex="-1"></a><span class="co">#&gt;    year   min    mean   max</span></span>
<span id="cb10-21"><a href="#cb10-21" tabindex="-1"></a><span class="co">#&gt;   &lt;int&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb10-22"><a href="#cb10-22" tabindex="-1"></a><span class="co">#&gt; 1  2015 -2.62 -0.0104  2.38</span></span>
<span id="cb10-23"><a href="#cb10-23" tabindex="-1"></a><span class="co">#&gt; 2  2017 -2.43  0.0762  2.53</span></span></code></pre></div>
<p>Note the use of the [dplyr::collect()] function at the end of each
call. This is necessary to convert the final result (which is processed
by Arrow) to a common R object (usually a <code>tibble</code> or
similar).</p>
<p>As stated before, the queries made by <code>query_gesla()</code> may
take some time to process. To avoid repeating this query in every new
session, you can save this object in a file locally, so it will be
available instantly the next time you may need it. To achieve this, you
can use the <code>write_gesla()</code> function</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="fu">write_gesla</span>(da)</span></code></pre></div>
<p>In this case, this call will create a file named
<code>gesla-data.parquet</code>, and it will be ready for reading at any
time, without the need for querying again. At any time, just use</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>da <span class="ot">&lt;-</span> <span class="fu">read_gesla</span>(<span class="st">&quot;gesla-data.parquet&quot;</span>)</span></code></pre></div>
<p>to make it available again.</p>
<p>Please, do not try to save this object as a standard R file, such as
<code>.rds</code> or <code>.rda</code>, as using <code>saveRDS</code> or
<code>save()</code> for example. In this case the resulting saved object
will not be the same as the original object, as an
<code>ArrowObject</code> object is not a standard R object (it actually
is just a pointer to an Arrow style opbject).</p>
<p>The <code>query_gesla()</code> function also has two more arguments.
The <code>use_flag = 1</code> means that only the data revised by the
GESLA team and usefull for analysis must be used. Please see the <a href="https://gesla787883612.wordpress.com/format/">GESLA format</a>
page for more information. The other argument,
<code>as_data_frame = FALSE</code> specifies if the resulting object
should be an <code>ArrowObject</code> (the default) or a
<code>data.frame</code>. We highly recommend to keep this default
option, as the resulting <code>data.frame</code> can be
larger-than-memory, resukting in a memory overflow or even an R session
crash. Keeping the object as an <code>ArrowObject</code> will always
guarantee that the resulting query will be made available. In any case,
an <code>ArrowObject</code> can always be converted to a
<code>data.frame</code>, if that is desired, without the need to repeat
the query with <code>as_data_frame = TRUE</code>. For example, the
object <code>da</code> created above (which is an
<code>ArrowObject</code>) may be converted to a <code>data.frame</code>
with</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="fu">class</span>(da)</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a><span class="co">#&gt; [1] &quot;Table&quot;        &quot;ArrowTabular&quot; &quot;ArrowObject&quot;  &quot;R6&quot;</span></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>db <span class="ot">&lt;-</span> da <span class="sc">|&gt;</span></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>    <span class="fu">collect</span>()</span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a><span class="fu">class</span>(db)</span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a><span class="co">#&gt; [1] &quot;tbl_df&quot;     &quot;tbl&quot;        &quot;data.frame&quot;</span></span></code></pre></div>
</div>
<div id="using-the-gesla-shiny-app" class="section level2">
<h2>Using the GESLA Shiny app</h2>
<p>The GESLA Shiny app (geslaR-app) was developed as a user-friendly
interface to explore the whole GESLA dataset. The app may be called
simply as</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="fu">run_gesla_app</span>()</span></code></pre></div>
<p>This will create a directory called <code>gesla-app</code> on the
current working directory, containing the necessary files for the app
itself, and a sub-directory called <code>gesla_dataset</code> containing
all the GESLA dataset files (as <code>.parquet</code> files, as this is
done with the <code>download_gesla()</code> function as explained
above). Note that the fisrt time this function is called, it will create
this directories and download the full GESLA dataset. However, once this
is done, the next time this function is called on this working
directory, only the app will open in the default browser (no more
downloads will be necessary).</p>
<p>This web-interface allows the user to apply some basic filters, by
choosing countries, years and sites. By doing this, the app will filter
the data and show many informations about the selected subset. The first
tab contains a preview of the selected subset. The two subsequent tabs
provide some plots with the number of information by year, and summary
plots for the sea level data itself. The last tab will show a map with
the selected locations, and by clicking on the locations, a pop-up will
show with information about that specific station.</p>
<p>The user has the option to download the selected subset in CSV or
Parquet file formats. We highly reccomend to export it as a Parquet
file, as the file size will be much smaller, and it can be simply loaded
into R with the <code>read_gesla()</code> function, creating an
<code>ArrowObject</code> object.</p>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
